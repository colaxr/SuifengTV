- name: Extract metadata
  id: meta
  uses: docker/metadata-action@v5
  with:
    images: ghcr.io/${{ steps.lowercase.outputs.owner }}/suifengtvn
    tags: |
      type=ref,event=pr
      type=raw,value=latest,enable={{is_default_branch}}

- name: Build and push by digest
  id: build
  uses: docker/build-push-action@v5
  with:
    context: .
    file: ./Dockerfile
    platforms: ${{ matrix.platform }}
    labels: ${{ steps.meta.outputs.labels }}
    tags: ${{ github.event_name == 'pull_request_target' && format('ghcr.io/{0}/suifengtvn:pr-{1}', steps.lowercase.outputs.owner, github.event.number) || format('ghcr.io/{0}/suifengtvn:{1}', steps.lowercase.outputs.owner, env.latest_tag || 'latest') }}
    outputs: type=image,name=ghcr.io/${{ steps.lowercase.outputs.owner }}/suifengtvn,name-canonical=true,push=true

- name: Create manifest list and push
  working-directory: /tmp/digests
  run: |
    docker buildx imagetools create -t ghcr.io/${{ steps.lowercase.outputs.owner }}/suifengtvn:pr-${{ github.event.number }} \
      $(printf 'ghcr.io/${{ steps.lowercase.outputs.owner }}/suifengtvn@sha256:%s ' *)

- name: Create manifest list and push
  working-directory: /tmp/digests
  run: |
    docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
      $(printf 'ghcr.io/${{ steps.lowercase.outputs.owner }}/suifengtvn@sha256:%s ' *)

- name: Inspect image
  run: |
    docker buildx imagetools inspect ghcr.io/${{ steps.lowercase.outputs.owner }}/suifengtvn:${{ steps.meta.outputs.version || 'latest' }}

- name: Comment on PR
  uses: actions/github-script@v7
  with:
    script: |
      github.rest.issues.createComment({
        issue_number: context.issue.number,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: `🎉 您的 PR 已构建完成！

      Docker 镜像已成功构建并推送到 GitHub Container Registry。

      **拉取命令：**
      \`\`\`bash
      docker pull ghcr.io/${{ steps.lowercase.outputs.owner }}/suifengtvn:pr-${{ github.event.number }}
      \`\`\`

      **标签：** \`pr-${{ github.event.number }}\`

      构建完成时间：${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}`
      });
